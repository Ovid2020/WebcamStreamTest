
<!DOCTYPE html>
<html>
  <head>
    <meta name="keywords" content="JavaScript, WebRTC" />
    <meta name="description" content="WebRTC codelab" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">

    <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    
    <script src='js/lib/adapter.js'></script>

    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  </head>
  <body>
    LOCAL VIDEO
    <video id="localVideo" autoplay="true"></video>
    <br>
    REMOTE VIDEO
    <video id="remoteVideo" autoplay="true"></video>


    <script>

      var signalingChannel = io("http://localhost:3000");
      var pc;
      var configuration = {iceServers: null};
      var localVideo = document.querySelector("#localVideo");
      var remoteVideo = document.querySelector("#remoteVideo");

      // run start(true) to initiate a call
      function start(isCaller) {
        console.log("here");
        pc = new RTCPeerConnection(null);
        console.log("not here");
        // send any ice candidates to the other peer
        pc.onicecandidate = function (evt) {
          //signalingChannel.send(JSON.stringify({ "candidate": evt.candidate }));
          signalingChannel.emit('send candidate', JSON.stringify({ "candidate": evt.candidate }));
        };

        // once remote stream arrives, show it in the remote video element
        pc.onaddstream = function (evt) {
          remoteVideo.src = window.URL.createObjectURL(evt.stream);
        };

        var handleVideo = function (stream) {

          localVideo.src = window.URL.createObjectURL(stream);
          pc.addStream(stream);

          if (isCaller) {
            pc.createOffer(gotDescription);
          } else {
            pc.createAnswer(pc.remoteDescription, gotDescription);
          }

          function gotDescription(desc) {
            pc.setLocalDescription(desc);
            signalingChannel.emit('send stream', JSON.stringify({ "sdp": desc }));
          };

          console.log("HANDLE VIDEO IS BEING CALLED");

        };

        var videoError = function (error) {
          console.log("ERROR! ", error)
        };

        // get the local stream, show it in the local video element and send it
        navigator.getUserMedia({ "audio": true, "video": true }, handleVideo, videoError);


      };

      signalingChannel.on('stream from server', function(evt) {
        if (!pc) {
          start(false);
        }
        console.log("EVT IS: ", evt);
        console.log("EVT.DATA IS: ", JSON.parse(evt.data));
        var signal = JSON.parse(evt.data);
        
        if (signal.sdp) {
         pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
        }
        else {
          pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
        }
      });
    </script>
    <script>
      $(document).ready(function(){
        start(true);
      })
    </script>
  </body>
</html>

